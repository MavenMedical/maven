RET=0

cd $MAVEN_ROOT
#git stash -q --keep-index

CHANGEDPY=`git diff --diff-filter=ACMRUXB --full-index --name-only HEAD -- '*.py' | grep -v site-packages`
if [[ -n "$CHANGEDPY" ]]; then
   if flake8 --ignore=E501,E123,E126 $CHANGEDPY; then
      echo flake8 lint succeeded
   else
      echo flake8 lint failed, commit aborting
      exit 1
   fi
fi



python unit_tests.py
if [ $? -eq 0 ]; then
   echo Tests passed, commit proceeding
   if find $MAVEN_ROOT/app/database/updates -name "*.sql" | grep -v "app/database/updates/\(\(schema\)\|\(data\)\)/[0-9]\{8\}/[0-9]\+\(-[a-z]\+\)\?.sql"; then
      echo you have misplaced sql update files, commit aborting
      RET=1
   else
      echo All unit tests passed
   fi
else
   echo TESTS FAILED, commit aborting
   RET=1
fi

#git stash pop -q
exit $RET