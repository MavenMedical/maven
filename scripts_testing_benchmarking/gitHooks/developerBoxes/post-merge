#All machines should copy this to their .git/hooks directory
#the following line (uncommented, of course) should be in your pg_hba.conf file to ensure this script will work
#local   all     postgres        trust
UPDATESSQL=../schema_updates.sql
UPDATESLOG=../schema_updates.log
if [ ! -f $UPDATESSQL ]; then
   touch $UPDATESSQL
fi
if [ ! -f $UPDATESLOG ]; then
   touch $UPDATESLOG
fi

for f in `git diff-tree -r --name-only HEAD ORIG_HEAD app/database/updates/schema | sort -n` `git diff-tree -r --name-only HEAD ORIG_HEAD app/database/updates/data | sort -n`; do
  echo $f
  if grep "SUCCEEDED: $f" $UPDATESLOG; then
    echo $f already succeeded in log, did someone update the file - which should not happen
  else
  echo "------------------`date`---------------">>$UPDATESSQL
  echo "------------------$f------------------">>$UPDATESSQL
  echo "------------------`date`---------------">>$UPDATESLOG
  echo "------------------$f---------------">>$UPDATESLOG
  psql maven -U postgres -v ON_ERROR_STOP=1 -1 -w -f $f >> $UPDATESLOG 2>&1
  if [ $? -eq 0 ]; then
    cat $f>>$UPDATESSQL
    echo ------------------SUCCEEDED: $f------->>$UPDATESLOG
  else
    echo FAILED on $f
    echo ------------------FAILED: $f------->>$UPDATESLOG
  fi
  fi
done

